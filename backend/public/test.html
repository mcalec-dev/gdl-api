<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload Test</title>
  </head>
  <body>
    <div class="container">
      <h1>file upload test</h1>
      <div class="upload-area">
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" />
          <label for="fileInput" class="file-label">Choose File</label>
        </div>
        <div class="file-info" id="fileInfo">
          <div class="file-name" id="fileName"></div>
          <div class="file-size" id="fileSize"></div>
        </div>
        <div class="button-group">
          <button class="upload-btn" id="uploadBtn" disabled>Upload</button>
          <button class="clear-btn" id="clearBtn" disabled>Clear</button>
        </div>
        <div class="status" id="status">
          <div class="status-message" id="statusMessage"></div>
          <div class="file-id" id="fileIdDisplay"></div>
          <a
            href="#"
            class="download-link"
            id="downloadLink"
            style="display: none"
          >
            Download File
          </a>
        </div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById('fileInput')
      const uploadBtn = document.getElementById('uploadBtn')
      const clearBtn = document.getElementById('clearBtn')
      const fileInfo = document.getElementById('fileInfo')
      const fileName = document.getElementById('fileName')
      const fileSize = document.getElementById('fileSize')
      const status = document.getElementById('status')
      const statusMessage = document.getElementById('statusMessage')
      const fileIdDisplay = document.getElementById('fileIdDisplay')
      const downloadLink = document.getElementById('downloadLink')

      let selectedFile = null

      // Format file size to human readable
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes'
        const k = 1024
        const sizes = ['Bytes', 'KB', 'MB', 'GB']
        const i = Math.floor(Math.log(bytes) / Math.log(k))
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i]
      }

      // Handle file selection
      fileInput.addEventListener('change', (e) => {
        selectedFile = e.target.files[0]

        if (selectedFile) {
          fileName.textContent = 'üìÑ ' + selectedFile.name
          fileSize.textContent = formatFileSize(selectedFile.size)
          fileInfo.classList.add('show')
          uploadBtn.disabled = false
          clearBtn.disabled = false
          status.classList.remove('show')
        }
      })

      // Handle clear button
      clearBtn.addEventListener('click', () => {
        fileInput.value = ''
        selectedFile = null
        fileInfo.classList.remove('show')
        uploadBtn.disabled = true
        clearBtn.disabled = true
        status.classList.remove('show')
        downloadLink.style.display = 'none'
      })

      // Handle upload
      uploadBtn.addEventListener('click', async () => {
        if (!selectedFile) return

        uploadBtn.disabled = true
        clearBtn.disabled = true
        fileInput.disabled = true

        // Show loading status
        status.className = 'status show loading'
        statusMessage.textContent = 'Uploading...'
        fileIdDisplay.textContent = ''
        downloadLink.style.display = 'none'

        try {
          const formData = new FormData()
          formData.append('file', selectedFile)

          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
          })

          const data = await response.json()

          if (response.ok && data.success) {
            // Show success status
            status.className = 'status show success'
            statusMessage.textContent = '‚úì File uploaded successfully!'
            fileIdDisplay.innerHTML =
              '<strong>File ID:</strong><br>' + data.fileId

            // Setup download link
            downloadLink.href = '/api/gridfs/' + data.fileId
            downloadLink.download = data.filename
            downloadLink.textContent = '‚¨áÔ∏è Download Uploaded File'
            downloadLink.style.display = 'block'

            // Reset form
            fileInput.value = ''
            selectedFile = null
            fileInfo.classList.remove('show')
            fileInput.disabled = false
          } else {
            throw new Error(data.error || 'Upload failed')
          }
        } catch (error) {
          status.className = 'status show error'
          statusMessage.textContent = '‚úó Upload failed: ' + error.message
          fileIdDisplay.textContent = ''
          downloadLink.style.display = 'none'
          uploadBtn.disabled = false
          clearBtn.disabled = false
          fileInput.disabled = false
        }
      })
    </script>
  </body>
</html>
